<?php
/**
 * Provide a admin area view for the malware detection feature
 *
 * @link       https://danovatesolutions.org
 * @since      1.0.0
 *
 * @package    Kura_AI
 * @subpackage Kura_AI/admin/partials/malware-detection
 */

// Get latest scan results
global $wpdb;
$latest_scan = null;
if ($wpdb) {
    $table_name = $wpdb->prefix . 'kura_ai_security_reports';
    // Check if table exists before querying - using prepare to prevent SQL injection
    $table_exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $table_name)) === $table_name;
    if ($table_exists) {
        $latest_scan = $wpdb->get_row(
            $wpdb->prepare(
                "SELECT * FROM %i WHERE report_type = %s ORDER BY created_at DESC LIMIT 1",
                $table_name,
                'malware_scan'
            )
        );
    }
}

$scan_results = $latest_scan ? maybe_unserialize($latest_scan->report_data) : null;
$settings = \get_option('kura_ai_settings', []);

// Set default malware detection settings if not exists
if (!isset($settings['malware_detection'])) {
    $settings['malware_detection'] = [
        'enabled' => true,
        'ai_threshold' => 75,
        'scan_frequency' => 'daily',
        'quarantine_enabled' => true
    ];
}
?>

<div class="wrap kura-ai-malware-detection" id="malware-detection-page">
    <h1><?php echo \esc_html__('AI-Powered Malware Detection', 'kura-ai'); ?></h1>

    <!-- Settings Section -->
    <div class="kura-ai-card kura-ai-settings-card">
        <h2><?php echo \esc_html__('Malware Detection Settings', 'kura-ai'); ?></h2>
        <form method="post" action="options.php" class="kura-ai-settings-form">
            <?php \settings_fields('kura_ai_settings'); ?>
            <table class="form-table">
                <tr>
                    <th scope="row">
                        <label for="malware_detection_enabled">
                            <?php echo \esc_html__('Enable Malware Detection', 'kura-ai'); ?>
                        </label>
                    </th>
                    <td>
                        <label class="kura-ai-switch">
                            <input type="checkbox" 
                                   id="malware_detection_enabled"
                                   name="kura_ai_settings[malware_detection][enabled]"
                                   <?php \checked($settings['malware_detection']['enabled']); ?>
                            >
                            <span class="kura-ai-slider"></span>
                        </label>
                    </td>
                </tr>
                <tr>
                    <th scope="row">
                        <label for="ai_threshold">
                            <?php echo \esc_html__('AI Confidence Threshold', 'kura-ai'); ?>
                        </label>
                    </th>
                    <td>
                        <input type="range" 
                               id="ai_threshold"
                               name="kura_ai_settings[malware_detection][ai_threshold]"
                               min="0" 
                               max="1" 
                               step="0.1"
                               value="<?php echo esc_attr($settings['malware_detection']['ai_threshold']); ?>"
                        >
                        <span class="threshold-value"><?php echo esc_html($settings['malware_detection']['ai_threshold']); ?></span>
                    </td>
                </tr>
                <tr>
                    <th scope="row">
                        <label for="scan_frequency">
                            <?php echo \esc_html__('Scan Frequency', 'kura-ai'); ?>
                        </label>
                    </th>
                    <td>
                        <select id="scan_frequency" 
                                name="kura_ai_settings[malware_detection][scan_frequency]">
                            <option value="hourly" <?php \selected($settings['malware_detection']['scan_frequency'], 'hourly'); ?>>
                                <?php echo \esc_html__('Hourly', 'kura-ai'); ?>
                            </option>
                            <option value="daily" <?php \selected($settings['malware_detection']['scan_frequency'], 'daily'); ?>>
                                <?php echo \esc_html__('Daily', 'kura-ai'); ?>
                            </option>
                            <option value="weekly" <?php \selected($settings['malware_detection']['scan_frequency'], 'weekly'); ?>>
                                <?php echo \esc_html__('Weekly', 'kura-ai'); ?>
                            </option>
                        </select>
                    </td>
                </tr>
            </table>
            <?php \submit_button(\__('Save Settings', 'kura-ai')); ?>
        </form>
    </div>

    <!-- Scan Control Section -->
    <div class="kura-ai-card kura-ai-scan-control">
        <h2><?php echo \esc_html__('Malware Scan Control', 'kura-ai'); ?></h2>
        <div class="scan-status">
            <?php if ($scan_results && $scan_results['scan_status'] === 'in_progress'): ?>
                <div class="scan-progress">
                    <div class="progress-bar">
                        <div class="progress" style="width: <?php echo esc_attr(($scan_results['files_scanned'] / $scan_results['total_files']) * 100); ?>%"></div>
                    </div>
                    <p class="description">
                        <?php echo esc_html(sprintf(
                            __('Scanning: %d of %d files', 'kura-ai'),
                            $scan_results['files_scanned'],
                            $scan_results['total_files']
                        )); ?>
                    </p>
                </div>
            <?php else: ?>
                <p class="last-scan">
                    <?php if ($latest_scan): ?>
                        <?php echo esc_html(sprintf(
                            __('Last scan completed: %s', 'kura-ai'),
                            \wp_date(\get_option('date_format') . ' ' . \get_option('time_format'), \strtotime($latest_scan->created_at))
                        )); ?>
                    <?php else: ?>
                        <?php echo \esc_html__('No previous scans found', 'kura-ai'); ?>
                    <?php endif; ?>
                </p>
            <?php endif; ?>
        </div>
        <div class="scan-actions">
            <button type="button" 
                    id="start-malware-scan"
                    class="button button-primary"
                    <?php echo ($scan_results && $scan_results['scan_status'] === 'in_progress') ? 'disabled' : ''; ?>>
                <?php echo \esc_html__('Start New Scan', 'kura-ai'); ?>
            </button>
            <?php if ($scan_results && $scan_results['scan_status'] === 'in_progress'): ?>
                <button type="button" id="cancel-malware-scan" class="button button-secondary">
                    <?php echo \esc_html__('Cancel Scan', 'kura-ai'); ?>
                </button>
            <?php endif; ?>
        </div>
    </div>

    <!-- Results Section -->
    <?php if ($scan_results && !empty($scan_results['threats_detected'])): ?>
        <div class="kura-ai-card kura-ai-threats-detected">
            <h2>
                <?php echo esc_html(sprintf(
                    __('Threats Detected (%d)', 'kura-ai'),
                    count($scan_results['threats_detected'])
                )); ?>
            </h2>
            <div class="threats-table-wrapper">
                <table class="wp-list-table widefat fixed striped threats-table">
                    <thead>
                        <tr>
                            <th scope="col"><?php echo \esc_html__('File', 'kura-ai'); ?></th>
                            <th scope="col"><?php echo \esc_html__('Severity', 'kura-ai'); ?></th>
                            <th scope="col"><?php echo \esc_html__('AI Confidence', 'kura-ai'); ?></th>
                            <th scope="col"><?php echo \esc_html__('Detection Time', 'kura-ai'); ?></th>
                            <th scope="col"><?php echo \esc_html__('Actions', 'kura-ai'); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($scan_results['threats_detected'] as $threat): ?>
                            <tr>
                                <td><?php echo esc_html($threat['file']); ?></td>
                                <td>
                                    <span class="severity-badge severity-<?php echo esc_attr(strtolower($threat['severity'])); ?>">
                                        <?php echo esc_html(ucfirst($threat['severity'])); ?>
                                    </span>
                                </td>
                                <td>
                                    <div class="confidence-meter">
                                        <div class="confidence-bar" style="width: <?php echo esc_attr($threat['ai_confidence'] * 100); ?>%"></div>
                                        <span class="confidence-value"><?php echo esc_html(number_format($threat['ai_confidence'] * 100, 1)); ?>%</span>
                                    </div>
                                </td>
                                <td><?php echo esc_html(\wp_date(
                                    \get_option('date_format') . ' ' . \get_option('time_format'),
                                    \strtotime($threat['detection_time'])
                                )); ?></td>
                                <td class="threat-actions">
                                    <button type="button" 
                                            class="button button-small view-details"
                                            data-threat="<?php echo esc_attr(json_encode($threat)); ?>">
                                        <?php echo \esc_html__('View Details', 'kura-ai'); ?>
                                    </button>
                                    <button type="button" 
                                            class="button button-small button-primary quarantine-file"
                                            data-file="<?php echo esc_attr($threat['file']); ?>">
                                        <?php echo \esc_html__('Quarantine', 'kura-ai'); ?>
                                    </button>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Threat Details Modal -->
        <div id="threat-details-modal" class="kura-ai-modal">
            <div class="kura-ai-modal-content">
                <span class="close-modal">&times;</span>
                <h2><?php echo \esc_html__('Threat Details', 'kura-ai'); ?></h2>
                <div class="threat-details-content"></div>
            </div>
        </div>
    <?php elseif ($scan_results && $scan_results['scan_status'] === 'completed'): ?>
        <div class="kura-ai-card kura-ai-no-threats">
            <div class="no-threats-message">
                <span class="dashicons dashicons-shield-alt"></span>
                <h3><?php echo \esc_html__('No Threats Detected', 'kura-ai'); ?></h3>
                <p><?php echo \esc_html__('Your website is currently free from detected malware.', 'kura-ai'); ?></p>
            </div>
        </div>
    <?php endif; ?>
</div>